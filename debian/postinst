#!/bin/sh

set -e

PREFERENCES=/etc/apt/listchanges.conf
APT_CONFIG=/etc/apt/apt.conf.d/20-apt-listchanges.conf

mkdir -p /etc/apt/apt.conf.d

# Source debconf library.
. /usr/share/debconf/confmodule

# Wipe out any old configuration (preserve permissions, though)
[ -f "$APT_CONFIG" ] && : > $APT_CONFIG
[ -f "$PREFERENCES" ] && : > $PREFERENCES

# Should we hook into apt?
db_get apt-listchanges/apt-hook-p

if [ "$RET" = "true" ]; then
  cat <<EOF >> $APT_CONFIG
DPkg::Pre-Install-Pkgs { "/usr/bin/apt-listchanges --apt"; };
EOF
else
  rm -f $APT_CONFIG
fi

echo "# Changes made here will be lost.  Please use dpkg-reconfigure apt-listchanges" >> $PREFERENCES

db_get apt-listchanges/frontend

echo "frontend=$RET" >> $PREFERENCES

db_get apt-listchanges/email-address

echo "email-address=$RET" >> $PREFERENCES

db_get apt-listchanges/confirm
if [ "$RET" = "true" ]; then
  echo "confirm=yes" >> $PREFERENCES
else
  echo "confirm=no" >> $PREFERENCES
fi

## Cleanup from older versions (1.13 and earlier)

# Remove config files from older versions
rm -f /etc/apt-listchanges.conf /etc/apt-listchanges.conf.old

# We used to add ourselves to apt.conf; remove ourselves
if [ -e /etc/apt/apt.conf ]; then
        cp /etc/apt/apt.conf /etc/apt/apt.conf.old
        (grep -v apt-listchanges /etc/apt/apt.conf.old > /etc/apt/apt.conf) || true
        rm -f /etc/apt/apt.conf.old
        if [ ! -s /etc/apt/apt.conf ]; then
                rm -f /etc/apt/apt.conf
                rmdir --ignore-fail-on-non-empty -p /etc/apt/
        fi
fi


# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
